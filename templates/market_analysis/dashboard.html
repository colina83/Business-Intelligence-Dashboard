{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard - TGS Market Analysis{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'market_analysis/css/dashboard.css' %}">
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="gh-page-header">
    <h1 class="gh-page-title">
        <i class="bi bi-speedometer2 me-2"></i>Market Analysis Dashboard
    </h1>
</div>
<hr class="gh-divider mb-4">

<!-- ROW 1: Active Projects Table (Ongoing/Submitted) -->
<div class="gh-card mb-4">
    <div class="gh-card-header">
        <h3 class="gh-card-title">
            <i class="bi bi-folder-check me-2"></i>Open Tendering Activity
        </h3>
    </div>
    <div class="gh-card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover table-bordered mb-0">
                <thead class="table-dark">
                    <tr>
                        <th scope="col" class="col-internal-id">Internal ID</th>
                        <th scope="col">Bid Received</th>
                        <th scope="col">Deadline</th>
                        <th scope="col">Days to Deadline</th>
                        <th scope="col">Bid Submitted</th>
                        <th scope="col">Status</th>
                        <th scope="col">Comments</th>
                        <th scope="col" class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in active_projects %}
                    <tr>
                        <!-- removed text-nowrap so value can wrap if needed and column auto-sizes -->
                        <td class="col-internal-id">
                            <a href="{% url 'market_analysis:project_detail' project_id=p.project_id %}" class="text-decoration-none">
                                <code class="gh-code" title="{{ p.internal_id|default:'' }}" style="cursor: pointer;">{{ p.internal_id|default:"-" }}</code>
                            </a>
                        </td>

                        <td class="text-nowrap">{% if p.date_received %}{{ p.date_received|date:"Y-m-d" }}{% else %}-{% endif %}</td>
                        <td class="text-nowrap">{% if p.deadline_date %}{{ p.deadline_date|date:"Y-m-d" }}{% else %}-{% endif %}</td>
                        <td class="text-center">
                            {% if p.days_to_deadline is not None %}
                                {% if p.days_to_deadline < 0 %}
                                    <span class="gh-badge gh-badge-danger">Overdue</span>
                                {% elif p.days_to_deadline < 10 %}
                                    <span class="gh-badge gh-badge-danger">{{ p.days_to_deadline }}</span>
                                {% else %}
                                    <span class="gh-badge gh-badge-success">{{ p.days_to_deadline }}</span>
                                {% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="text-nowrap">{% if p.submission_date %}{{ p.submission_date|date:"Y-m-d" }}{% else %}-{% endif %}</td>

                        <!-- centered status cell -->
                        <td class="status-cell">
                            {% if p.status == 'Ongoing' %}
                                <button type="button"
                                        class="gh-status-badge gh-status-ongoing status-pill btn btn-sm btn-primary d-inline-flex align-items-center"
                                        data-project-id="{{ p.project_id }}" data-status="Ongoing"
                                        data-submission="{% if p.submission_date %}{{ p.submission_date|date:'Y-m-d' }}{% endif %}">
                                    <i class="bi bi-play-circle"></i>
                                    <span class="ms-1 status-label">Ongoing</span>
                                </button>
                            {% elif p.status == 'Submitted' %}
                                <button type="button"
                                        class="gh-status-badge gh-status-submitted status-pill btn btn-sm btn-warning d-inline-flex align-items-center"
                                        data-project-id="{{ p.project_id }}" data-status="Submitted"
                                        data-submission="{% if p.submission_date %}{{ p.submission_date|date:'Y-m-d' }}{% endif %}"
                                        data-award="{% if p.award_date %}{{ p.award_date|date:'Y-m-d' }}{% endif %}"
                                        data-lost="{% if p.lost_date %}{{ p.lost_date|date:'Y-m-d' }}{% endif %}">
                                    <i class="bi bi-hourglass-split"></i>
                                    <span class="ms-1 status-label">Submitted</span>
                                </button>
                            {% endif %}
                        </td>

                        <td class="comments-cell">
                            <span class="comments-text" title="{{ p.comments|default:'' }}">{{ p.comments|default:"-"|truncatechars:30 }}</span>
                        </td>

                        <!-- Actions: centered, colored bootstrap buttons, icons only -->
                        <td class="text-center">
                            <div class="gh-actions" role="group" aria-label="project actions">
                                <!-- Edit -->
                                <a href="{% url 'market_analysis:project_edit' project_id=p.project_id %}"
                                   class="gh-btn btn btn-outline-primary gh-btn-sm"
                                   title="Edit Project">
                                    <i class="bi bi-pencil-square"></i>
                                </a>

                                <!-- Scope -->
                                {% if p.has_scope %}
                                <a href="{% url 'market_analysis:project_scope' project_id=p.project_id %}"
                                   class="gh-btn btn btn-outline-info gh-btn-sm"
                                   title="View Scope">
                                    <i class="bi bi-file-earmark-text"></i>
                                </a>
                                {% else %}
                                <a href="{% url 'market_analysis:project_scope' project_id=p.project_id %}"
                                   class="gh-btn btn btn-success gh-btn-sm"
                                   title="Add Scope">
                                    <i class="bi bi-plus-circle"></i>
                                </a>
                                {% endif %}

                                <!-- Financial -->
                                <a href="{% url 'market_analysis:project_add_financial' project_id=p.project_id %}"
                                   class="gh-btn btn btn-outline-secondary gh-btn-sm"
                                   title="{% if p.has_financial %}View P&L{% else %}Add P&L{% endif %}">
                                    <i class="bi bi-{% if p.has_financial %}wallet-fill{% else %}wallet{% endif %}"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            No active projects found.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div><!-- /.table-responsive -->

        <!-- Active Projects Pagination -->
        {% if active_projects_paginator.num_pages > 1 %}
        <div class="gh-pagination-wrapper">
            <nav aria-label="Active projects pagination">
                <ul class="gh-pagination">
                    {% if active_projects_page_obj.has_previous %}
                        <li><a href="?active_page={{ active_projects_page_obj.previous_page_number }}" class="gh-page-link">&laquo; Previous</a></li>
                    {% else %}
                        <li><span class="gh-page-link disabled">&laquo; Previous</span></li>
                    {% endif %}

                    {% for num in active_projects_page_range %}
                        {% if num == '...' %}
                            <li><span class="gh-page-link disabled">…</span></li>
                        {% else %}
                            <li><a href="?active_page={{ num }}" class="gh-page-link {% if num == active_projects_page_obj.number %}active{% endif %}">{{ num }}</a></li>
                        {% endif %}
                    {% endfor %}

                    {% if active_projects_page_obj.has_next %}
                        <li><a href="?active_page={{ active_projects_page_obj.next_page_number }}" class="gh-page-link">Next &raquo;</a></li>
                    {% else %}
                        <li><span class="gh-page-link disabled">Next &raquo;</span></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<!-- ROW 2: Charts Row -->
<div class="row g-4 mb-4">
    <!-- Left: Win/Lost Pie Chart -->
    <div class="col-md-6">
        <div class="gh-card h-100">
            <div class="gh-card-header">
                <h3 class="gh-card-title">
                    <i class="bi bi-pie-chart-fill me-2"></i>Tenders Win/Lost 2021 – {{ current_year }}
                </h3>
            </div>
            <div class="gh-card-body d-flex align-items-center justify-content-center">
                <div class="chart-container" style="position: relative; width: 100%; max-width: 400px;">
                    <canvas id="winLostChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Right: EBIT/Day Bar Chart -->
    <div class="col-md-6">
        <div class="gh-card h-100">
            <div class="gh-card-header">
                <h3 class="gh-card-title">
                    <i class="bi bi-bar-chart-fill me-2"></i>EBIT/Day - Latest 6 Tenders
                </h3>
            </div>
            <div class="gh-card-body d-flex align-items-center justify-content-center">
                <div class="chart-container" style="position: relative; width: 100%;">
                    <canvas id="ebitDayChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- provide a JS mapping of status labels so client script never has to read DOM options -->
<script>
  const STATUS_LABELS = {
    {% for key,label in status_choices %}
      "{{ key }}": "{{ label }}"{% if not forloop.last %},{% endif %}
    {% endfor %}
  };
</script>

<!-- Tendering Cycle Time Table -->
{# Tendering Cycle Time removed from main dashboard - available at /market/tendering-cycle/ #}

<!-- Enhanced status modal -->
<div class="modal fade" id="contractModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="contractForm" method="post" action="{% url 'market_analysis:project_contract' project_id=0 %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-gear me-2"></i>Project Status & Contract</h5>
          <button type="button" class="btn btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" id="contractProjectId" name="project_id" value="">

          <!-- Status select (shown for Ongoing/Submitted) -->
          <div class="mb-3" id="statusSelectRow" style="display:none;">
            <label class="form-label small">Change Status</label>
            <select id="newStatusSelect" name="new_status" class="form-select form-select-sm">
              <option value="">Select status</option>
              {% for key,label in status_choices %}
                <option value="{{ key }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Submission date (shown when choosing Submitted) -->
          <div class="mb-3" id="submissionRow" style="display:none;">
            <label class="form-label small">Submission Date</label>
            <input type="date" id="submissionDate" name="submission_date" class="form-control form-control-sm" />
          </div>

          <!-- Award date (shown when choosing Won or when current is Won) -->
          <div class="mb-3" id="awardRow" style="display:none;">
            <label class="form-label small">Award Date</label>
            <input type="date" id="awardDate" name="award_date" class="form-control form-control-sm" />
          </div>

          <!-- Contract date (only for projects that are already Won) -->
          <div class="mb-3" id="contractDateRow" style="display:none;">
            <label class="form-label small">Contract Date</label>
            <input type="date" id="contractDate" name="contract_date" class="form-control form-control-sm" />
          </div>

          <!-- Lost date (shown when choosing Lost or when current is Lost) -->
          <div class="mb-3" id="lostRow" style="display:none;">
            <label class="form-label small">Lost Date</label>
            <input type="date" id="lostDate" name="lost_date" class="form-control form-control-sm" />
          </div>

          <!-- Contract actual start/end and computed duration:
               Only shown for projects that are already Won (current status Won) -->
          <div id="contractRows" style="display:none;">
            <div class="mb-3">
              <label class="form-label small">Actual Start</label>
              <input type="date" class="form-control form-control-sm" id="actualStart" name="actual_start" />
            </div>
            <div class="mb-3">
              <label class="form-label small">Actual End</label>
              <input type="date" class="form-control form-control-sm" id="actualEnd" name="actual_end" />
            </div>
            <div class="mb-3 text-muted small">
              Actual duration (days): <span id="computedDuration" class="fw-semibold">-</span>
            </div>
          </div>

          <!-- Competitor select (shown when Lost selected or current Lost) -->
          <div class="mb-3" id="competitorField" style="display:none;">
            <label class="form-label small">Competitor (if Lost)</label>
            <select name="competitor" id="competitorSelect" class="form-select form-select-sm">
              <option value="">Unknown / Not specified</option>
              {% for code,label in competitor_choices %}
                <option value="{{ code }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary btn-sm">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'market_analysis/js/chart.min.js' %}"></script>
<script src="{% static 'market_analysis/js/dashboard.js' %}"></script>
<script>
// Compute cycle time values for the table rows on client side
document.addEventListener('DOMContentLoaded', function() {
    function parseISO(d) {
        if (!d) return null;
        var parts = d.split('-');
        if (parts.length !== 3) return null;
        return new Date(parts[0], parts[1]-1, parts[2]);
    }

    function diffDays(a,b) {
        if (!a || !b) return null;
        var diff = Math.floor((b - a) / (1000*60*60*24));
        return isNaN(diff) ? null : diff;
    }

    document.querySelectorAll('#cycleTimeTable .cycle-row').forEach(function(row){
        var received = parseISO(row.dataset.received);
        var submission = parseISO(row.dataset.submission);
        var award = parseISO(row.dataset.award);
        var contract = parseISO(row.dataset.contract);
        var lost = parseISO(row.dataset.lost);

        var daysToSubmission = diffDays(received, submission);
        var daysToAward = diffDays(submission || received, award);
        var daysToContract = diffDays(award || submission || received, contract);
        var daysToLost = diffDays(submission || received, lost);

        var totalCycle = null;
        // define total cycle as days from received to contract OR award OR lost
        if (contract) totalCycle = diffDays(received, contract);
        else if (award) totalCycle = diffDays(received, award);
        else if (lost) totalCycle = diffDays(received, lost);

        function setText(sel, val) {
            var el = row.querySelector(sel);
            if (!el) return;
            el.textContent = (val === null || val === undefined) ? '-' : String(val);
        }

        setText('.days-to-submission', daysToSubmission);
        setText('.days-to-award', daysToAward);
        setText('.days-to-contract', daysToContract);
        setText('.days-to-lost', daysToLost);
        setText('.total-cycle', totalCycle);
    });
});
</script>
<script>
// Chart.js initialization - inline to avoid timing issues with external script loading
document.addEventListener('DOMContentLoaded', function() {
    // Check if Chart.js is available
    if (typeof Chart === 'undefined') {
        console.error('Chart.js library not loaded. Charts will not be displayed.');
        // Show user-friendly message in chart containers
        var chartContainers = document.querySelectorAll('.chart-container');
        chartContainers.forEach(function(container) {
            container.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-exclamation-triangle fs-3 d-block mb-2"></i>Unable to load charts. Please refresh the page.</div>';
        });
        return;
    }

    // Win/Lost Pie Chart
    var winLostCanvas = document.getElementById('winLostChart');
    if (winLostCanvas) {
        var winLostCtx = winLostCanvas.getContext ? winLostCanvas.getContext('2d') : winLostCanvas;
        new Chart(winLostCtx, {
            type: 'doughnut',
            data: {
                labels: ['Won', 'Lost'],
                datasets: [{
                    data: [{{ win_count|default:0 }}, {{ lost_count|default:0 }}],
                    backgroundColor: [
                        '#009E73', /* teal - Win (colorblind-safe) */
                        '#CC79A7'  /* purple - Loss (colorblind-safe) */
                    ],
                    borderColor: [
                        '#ffffff',
                        '#ffffff'
                    ],
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            font: {
                                size: 14,
                                family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: '#24292f',
                        titleFont: {
                            size: 14
                        },
                        bodyFont: {
                            size: 13
                        },
                        padding: 12,
                        cornerRadius: 8
                    }
                },
                cutout: '60%'
            }
        });
    }

    // EBIT/Day Bar Chart
    var ebitDayCanvas = document.getElementById('ebitDayChart');
    if (ebitDayCanvas) {
        var ebitDayCtx = ebitDayCanvas.getContext ? ebitDayCanvas.getContext('2d') : ebitDayCanvas;
        var ebitData = {{ ebit_data|safe }};
        
        // Handle JSON parsing if needed
        if (!ebitData) ebitData = [];
        if (typeof ebitData === 'string') {
            try {
                ebitData = JSON.parse(ebitData);
            } catch (e) {
                console.error('Unable to parse ebit_data for chart', e);
                ebitData = [];
            }
        }
        
        var maxLabelLength = 25;
        var projectLabels = ebitData.map(function(item) {
            var name = item && item.name ? String(item.name) : '';
            if (name.length > maxLabelLength) {
                return name.substring(0, maxLabelLength) + '...';
            }
            return name;
        });
        var ebitValues = ebitData.map(function(item) {
            var v = item && (item.ebit_day !== undefined) ? Number(item.ebit_day) : 0;
            return isNaN(v) ? 0 : v;
        });
        var backgroundColors = ebitData.map(function(item) { return item && item.status === 'Won' ? '#009E73' : '#CC79A7'; });
        
        new Chart(ebitDayCtx, {
            type: 'bar',
            data: {
                labels: projectLabels,
                datasets: [{
                    label: 'EBIT/Day ($)',
                    data: ebitValues,
                    backgroundColor: backgroundColors,
                    borderColor: backgroundColors,
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                indexAxis: 'y',
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: '#24292f',
                        titleFont: {
                            size: 14
                        },
                        bodyFont: {
                            size: 13
                        },
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                var value = context.raw;
                                return 'EBIT/Day: $' + value.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: {
                            color: '#d0d7de'
                        },
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    },
                    y: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
