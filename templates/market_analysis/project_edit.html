{% extends "base.html" %}
{% load static %}
{% block title %}Edit Project - {{ project.name }}{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="card shadow-sm border-0 mx-auto" style="max-width:900px;">
    <div class="card-header bg-primary text-white">
      <h4 class="mb-0"><i class="bi bi-pencil-square me-2"></i>Edit Project</h4>
      <small class="text-white-50">{{ project.internal_id }}</small>
    </div>

    <div class="card-body">
      <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Bid Type</label>
            {{ form.bid_type }}
          </div>

          <div class="col-md-4">
            <label class="form-label">Client</label>
            {{ form.client }}
          </div>

          <div class="col-md-4">
            <label class="form-label">Region</label>
            {{ form.region }}
          </div>

          <div class="col-12">
            <label class="form-label">Project Name</label>
            {{ form.name }}
          </div>

          <div class="col-md-4">
            <label class="form-label">Country</label>
            {{ form.country }}
          </div>

          <div class="col-md-4">
            <label class="form-label">Date Received</label>
            {{ form.date_received }}
          </div>

          <div class="col-md-4">
            <label class="form-label">Status</label>
            {{ form.status }}
          </div>

          <div class="col-md-4">
            <label class="form-label">Deadline Date</label>
            {{ form.deadline_date }}
          </div>

          <div class="col-md-4" id="submission-date-col" style="display:none;">
            <label class="form-label">Submission Date</label>
            {{ form.submission_date }}
          </div>

          <div class="col-md-4" id="award-date-col" style="display:none;">
            <label class="form-label">Award Date</label>
            {{ form.award_date }}
          </div>

          <div class="col-md-4" id="lost-date-col" style="display:none;">
            <label class="form-label">Lost Date</label>
            {{ form.lost_date }}
          </div>

          <div class="col-12" id="competitor-col" style="display:none;">
            <label class="form-label">Competitor that won</label>
            {{ form.competitor_name }}
          </div>

          <div class="col-12">
            <label class="form-label">Comments</label>
            {{ form.comments }}
          </div>

          <div class="col-12">
            <label class="form-label">Project Map Image</label>
            {% if project.project_map %}
            <div class="mb-2">
              <img src="{{ project.project_map.url }}" alt="Current project map" style="max-width: 200px; max-height: 150px; border-radius: 6px; border: 1px solid #d0d7de;">
              <p class="text-muted small mt-1">Current image. Upload a new file to replace it.</p>
            </div>
            {% endif %}
            {{ form.project_map }}
            <small class="text-muted">Accepted formats: PNG, JPG, GIF. Max size: 5 MB.</small>
          </div>
        </div>

        <hr class="my-4">
        <div class="d-flex justify-content-between">
          <a href="{% url 'market_analysis:dashboard' %}" class="btn btn-outline-secondary">Cancel</a>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const statusEl = document.querySelector('[name="status"]');
    const submissionCol = document.getElementById('submission-date-col');
    const awardCol = document.getElementById('award-date-col');
    const lostCol = document.getElementById('lost-date-col');
    const competitorCol = document.getElementById('competitor-col');

    function refresh() {
        const status = statusEl ? statusEl.value : '';
        submissionCol.style.display = (status === 'Submitted') ? '' : 'none';
        awardCol.style.display = (status === 'Won') ? '' : 'none';
        lostCol.style.display = (status === 'Lost') ? '' : 'none';
        competitorCol.style.display = (status === 'Lost') ? '' : 'none';

        // ensure date inputs use native date picker (do not force readonly)
        const awardInput = document.querySelector('[name="award_date"]');
        const lostInput = document.querySelector('[name="lost_date"]');
        if (awardInput) {
            // make sure input type is date so browser shows picker
            try { awardInput.type = 'date'; } catch (e) {}
            awardInput.readOnly = false;
        }
        if (lostInput) {
            try { lostInput.type = 'date'; } catch (e) {}
            lostInput.readOnly = false;
        }
    }

    if (statusEl) {
        statusEl.addEventListener('change', refresh);
        refresh();
    }
});
</script>
{% endblock %}