{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Tendering Cycle Time - TGS Market Analysis{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'market_analysis/css/dashboard.css' %}">
<style>
  .gh-page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }
  
  .gh-page-title {
    font-size: 1.75rem;
    font-weight: 600;
    margin: 0;
  }
  
  .gh-divider {
    border: 0;
    border-top: 1px solid var(--gh-border-default);
    margin: 1rem 0 1.5rem 0;
  }
  
  .gh-card {
    background: white;
    border: 1px solid var(--gh-border-default);
    border-radius: 6px;
    margin-bottom: 1rem;
  }
  
  .gh-card-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--gh-border-default);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .gh-card-title {
    font-size: 1.125rem;
    font-weight: 600;
    margin: 0;
  }
  
  .gh-card-body {
    padding: 1.25rem;
  }
  
  .gh-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    font-weight: 500;
    border-radius: 12px;
  }
  
  .gh-badge-primary {
    background-color: rgba(9, 105, 218, 0.1);
    color: var(--gh-accent);
  }
  
  .gh-pagination {
    display: flex;
    list-style: none;
    padding: 0;
    margin: 0;
    gap: 0.25rem;
  }
  
  .gh-page-link {
    display: block;
    padding: 0.5rem 0.75rem;
    color: var(--gh-accent);
    text-decoration: none;
    border: 1px solid var(--gh-border-default);
    border-radius: 6px;
    font-size: 0.875rem;
  }
  
  .gh-page-link:hover:not(.disabled) {
    background-color: var(--gh-sidebar-bg);
  }
  
  .gh-page-link.disabled {
    color: var(--gh-text-secondary);
    cursor: not-allowed;
  }
  
  .chart-container {
    width: 100%;
    min-height: 400px;
    position: relative;
  }
  
  .stats-box {
    background: white;
    border: 1px solid var(--gh-border-default);
    border-radius: 6px;
    padding: 1.25rem;
  }
  
  .stats-item {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--gh-border-default);
  }
  
  .stats-item:last-child {
    border-bottom: none;
  }
  
  .stats-label {
    font-weight: 500;
    color: var(--gh-text-secondary);
  }
  
  .stats-value {
    font-weight: 600;
    color: var(--gh-text-primary);
  }
  
  .filter-controls {
    display: flex;
    gap: 1rem;
    align-items: center;
  }
  
  .filter-label {
    font-weight: 500;
    color: var(--gh-text-primary);
  }
  
  .filter-select {
    padding: 0.375rem 0.75rem;
    border: 1px solid var(--gh-border-default);
    border-radius: 6px;
    font-size: 0.875rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="gh-page-header">
    <h1 class="gh-page-title"><i class="bi bi-clock-history me-2"></i>Tendering Cycle Time</h1>
    <div class="filter-controls">
      <label for="yearFilter" class="filter-label">Filter by Year:</label>
      <select id="yearFilter" class="filter-select">
        <option value="all">All Years</option>
        {% for year in available_years %}
        <option value="{{ year }}">{{ year }}</option>
        {% endfor %}
      </select>
    </div>
</div>
<hr class="gh-divider mb-4">

<!-- ROW 1 -->
<div class="row mb-4">
  <!-- Column 1: Box & Whisker Chart -->
  <div class="col-md-6">
    <div class="gh-card">
      <div class="gh-card-header">
        <h3 class="gh-card-title">Milestone Cycle Times</h3>
      </div>
      <div class="gh-card-body">
        <div id="boxWhiskerChart" class="chart-container"></div>
      </div>
    </div>
  </div>
  
  <!-- Column 2: OBN Tenders Bar Chart -->
  <div class="col-md-6">
    <div class="gh-card">
      <div class="gh-card-header">
        <h3 class="gh-card-title">Number of OBN Tenders (Awarded), Projects Start Per Year</h3>
      </div>
      <div class="gh-card-body">
        <div id="obnTendersChart" class="chart-container"></div>
      </div>
    </div>
  </div>
</div>

<!-- ROW 2 -->
<div class="row mb-4">
  <!-- Column 1: Client Bar Chart -->
  <div class="col-md-6">
    <div class="gh-card">
      <div class="gh-card-header">
        <h3 class="gh-card-title">Number of OBN Tenders (Awarded) per Client</h3>
      </div>
      <div class="gh-card-body">
        <div id="clientChart" class="chart-container"></div>
      </div>
    </div>
  </div>
  
  <!-- Column 2: Statistics Box -->
  <div class="col-md-6">
    <div class="gh-card">
      <div class="gh-card-header">
        <h3 class="gh-card-title">Cycle Time Statistics</h3>
      </div>
      <div class="gh-card-body">
        <div id="statsBox" class="stats-box">
          <p class="text-muted text-center">Loading statistics...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ROW 3: Data Table -->
<div class="gh-card">
  <div class="gh-card-header">
    <h3 class="gh-card-title">Won Tenders Cycle Time</h3>
    <span class="gh-badge gh-badge-primary">{{ page_obj_won.paginator.count }} Records</span>
  </div>
  <div class="gh-card-body">
    <div class="table-responsive">
      <table class="table table-sm table-striped table-bordered mb-0">
        <thead class="table-light small">
          <tr>
            <th>Internal ID</th>
            <th>Project</th>
            <th>Client</th>
            <th class="text-end">Rec to Sub (days)</th>
            <th class="text-end">Sub to Award (days)</th>
            <th class="text-end">Award to Contract (days)</th>
            <th class="text-end">Contract to Start (days)</th>
            <th class="text-end">Rec to Start (days)</th>
            <th class="text-end">Award to Start (days)</th>
          </tr>
        </thead>
        <tbody>
          {% for p in page_obj_won.object_list %}
          <tr>
            <td class="text-nowrap"><a href="{% url 'market_analysis:project_detail' project_id=p.project_id %}"><code>{{ p.internal_id|default:'-' }}</code></a></td>
            <td>{{ p.name|default:'-' }}</td>
            <td>{% if p.client %}{{ p.client.name }}{% else %}-{% endif %}</td>
            <td class="text-end">{% if p.cycle_rec_to_sub is not None %}{{ p.cycle_rec_to_sub }}{% else %}-{% endif %}</td>
            <td class="text-end">{% if p.cycle_sub_to_award is not None %}{{ p.cycle_sub_to_award }}{% else %}-{% endif %}</td>
            <td class="text-end">{% if p.cycle_award_to_contract is not None %}{{ p.cycle_award_to_contract }}{% else %}-{% endif %}</td>
            <td class="text-end">{% if p.cycle_contract_to_start is not None %}{{ p.cycle_contract_to_start }}{% else %}-{% endif %}</td>
            <td class="text-end">{% if p.cycle_rec_to_start is not None %}{{ p.cycle_rec_to_start }}{% else %}-{% endif %}</td>
            <td class="text-end">{% if p.cycle_award_to_start is not None %}{{ p.cycle_award_to_start }}{% else %}-{% endif %}</td>
          </tr>
          {% empty %}
          <tr><td colspan="9" class="text-center text-muted py-3">No won tenders found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
      {% if page_obj_won.paginator.num_pages > 1 %}
      <div class="gh-pagination-wrapper mt-3">
        <nav aria-label="Won tenders pagination">
          <ul class="gh-pagination">
            {% if page_obj_won.has_previous %}
              <li><a href="?page={{ page_obj_won.previous_page_number }}" class="gh-page-link">&laquo; Previous</a></li>
            {% else %}
              <li><span class="gh-page-link disabled">&laquo; Previous</span></li>
            {% endif %}
            <li><span class="gh-page-link disabled">Page {{ page_obj_won.number }} of {{ page_obj_won.paginator.num_pages }}</span></li>
            {% if page_obj_won.has_next %}
              <li><a href="?page={{ page_obj_won.next_page_number }}" class="gh-page-link">Next &raquo;</a></li>
            {% else %}
              <li><span class="gh-page-link disabled">Next &raquo;</span></li>
            {% endif %}
          </ul>
        </nav>
      </div>
      {% endif %}
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-box-and-violin@3.0.0/dist/chartjs-chart-box-and-violin.min.js"></script>
<script>
let currentYear = 'all';

// Chart.js instances
let boxChart = null, obnChart = null, clientChart = null;

async function loadChartData(year) {
  try {
    const response = await fetch(`?format=json&year=${year}`);
    const data = await response.json();
    updateBoxWhiskerChart(data.cycle_data, year);
    updateOBNChart(data.obn_by_year);
    updateClientChart(data.client_data);
    updateStats(data.stats);
  } catch (error) {
    console.error('Error loading chart data:', error);
  }
}

function updateBoxWhiskerChart(cycleData, year) {
  const labels = ['Receipt → Submission','Submission → Award','Award → Contract','Contract → Start'];
  const datasetValues = [cycleData.rec_to_sub || [], cycleData.sub_to_award || [], cycleData.award_to_contract || [], cycleData.contract_to_start || []];

  const data = {
    labels: labels,
    datasets: [{
      label: 'Cycle times',
      backgroundColor: ['#0969da','#1a7f37','#9a6700','#cf222e'],
      borderColor: '#222',
      borderWidth: 1,
      data: datasetValues
    }]
  };

  const config = {
    type: 'boxplot',
    data: data,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        title: { display: true, text: year === 'all' ? 'All Years' : year }
      },
      scales: { y: { title: { display: true, text: 'Days' }, grid: { color: '#e1e4e8' } } }
    }
  };

  const ctx = document.getElementById('boxWhiskerChart') || document.getElementById('boxWhiskerChart');
  // ensure canvas element exists inside container
  if (!ctx.querySelector('canvas')) {
    ctx.innerHTML = '<canvas></canvas>';
  }
  const canvas = ctx.querySelector('canvas');
  if (boxChart) { boxChart.destroy(); }
  boxChart = new Chart(canvas.getContext('2d'), config);
}

function updateOBNChart(obnData) {
  const labels = obnData.years || [];
  const data = {
    labels: labels,
    datasets: [
      { label: 'ITT Receipts', data: obnData.received || [], backgroundColor: '#0969da' },
      { label: 'Project Starts', data: obnData.started || [], backgroundColor: '#1a7f37' }
    ]
  };

  const config = {
    type: 'bar',
    data: data,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'top' } },
      scales: { x: { type: 'category' }, y: { grid: { color: '#e1e4e8' }, beginAtZero: true } }
    }
  };

  const ctx = document.getElementById('obnTendersChart');
  if (!ctx.querySelector('canvas')) ctx.innerHTML = '<canvas></canvas>';
  const canvas = ctx.querySelector('canvas');
  if (obnChart) { obnChart.destroy(); }
  obnChart = new Chart(canvas.getContext('2d'), config);
}

function updateClientChart(clientData) {
  const labels = clientData.names || [];
  const data = { labels: labels, datasets: [{ label: 'OBN Tenders', data: clientData.counts || [], backgroundColor: '#0969da' }] };
  const config = { type: 'bar', data: data, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'x', scales: { x: { ticks: { autoSkip: false } }, y: { grid: { color: '#e1e4e8' } } } } };

  const ctx = document.getElementById('clientChart');
  if (!ctx.querySelector('canvas')) ctx.innerHTML = '<canvas></canvas>';
  const canvas = ctx.querySelector('canvas');
  if (clientChart) { clientChart.destroy(); }
  clientChart = new Chart(canvas.getContext('2d'), config);
}

function updateStats(stats) {
  const statsBox = document.getElementById('statsBox');
  let html = '';
  function renderCategory(title, obj){
    let h = `<div class="stats-category mb-3"><h6 class="mb-2" style="color: var(--gh-text-primary); font-weight: 600;">${title}</h6>`;
    if (obj) {
      h += `<div class="stats-item"><span class="stats-label">Average:</span><span class="stats-value">${obj.mean} days</span></div>`;
      h += `<div class="stats-item"><span class="stats-label">Median:</span><span class="stats-value">${obj.median} days</span></div>`;
      h += `<div class="stats-item"><span class="stats-label">Range:</span><span class="stats-value">${obj.min}-${obj.max} days</span></div>`;
    }
    h += '</div>';
    return h;
  }
  html += renderCategory('ITT Receipt to Submission', stats.rec_to_sub);
  html += renderCategory('Submission to Award', stats.sub_to_award);
  html += renderCategory('Award to Final Contract', stats.award_to_contract);
  html += renderCategory('Final Contract to Project Start', stats.contract_to_start);
  statsBox.innerHTML = html;
}

document.getElementById('yearFilter').addEventListener('change', function(e) { currentYear = e.target.value; loadChartData(currentYear); });

// initial load
loadChartData('all');
</script>
{% endblock %}
